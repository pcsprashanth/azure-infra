name: 'Terragrunt'

on:
    push:
        branches:
            - main

jobs:
    terragrunt:
        name: 'Terragrunt'
        runs-on: ubuntu-latest
        permissions:
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: Azure Login
              uses: azure/login@v1
              with:
                    client-id: ${{ secrets.ARM_CLIENT_ID }}
                    tenant-id: ${{ secrets.ARM_TENANT_ID }}
                    subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v1
              with:
                    terraform_version: 0.14.0

            - name: Install Terragrunt
              run: |
                    TERRAGRUNT_VERSION=$(curl --silent "https://api.github.com/repos/gruntwork-io/terragrunt/releases/latest" | jq -r .tag_name)
                    curl -LOs https://github.com/gruntwork-io/terragrunt/releases/download/${TERRAGRUNT_VERSION}/terragrunt_linux_amd64
                    chmod +x terragrunt_linux_amd64
                    sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

            - name: Terragrunt Init
              run: terragrunt init
              working-directory: environments

            - name: Terragrunt Plan
              run: terragrunt plan
              working-directory: environments

            - name: Terragrunt Apply
              run: terragrunt apply -auto-approve
              working-directory: environments