name: 'Terragrunt'

on:
    push:
        branches:
            - main

jobs:
    terragrunt:
        name: 'Terragrunt'
        runs-on: ubuntu-latest
        permissions:
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v3
              


            - name: Azure Login
              uses: azure/login@v1
              with:
                    client-id: ${{ secrets.ARM_CLIENT_ID }}
                    tenant-id: ${{ secrets.ARM_TENANT_ID }}
                    subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v1
              with:
                    terraform_version: 0.14.0
               

            - name: Install Terragrunt
              run: |
                    TERRAGRUNT_VERSION=$(curl --silent "https://api.github.com/repos/gruntwork-io/terragrunt/releases/latest" | jq -r .tag_name)
                    curl -LOs https://github.com/gruntwork-io/terragrunt/releases/download/${TERRAGRUNT_VERSION}/terragrunt_linux_amd64
                    chmod +x terragrunt_linux_amd64
                    sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
            
            - name: Print GitHub repository
              run: echo $GITHUB_REPOSITORY
            - name: Checkout repository
              uses: actions/checkout@v2
            - name: List directory contents
              run: ls -la /home/runner/work
  
            - name: Change working directory
              run: |
                cd /home/runner/work/pcsprashanth/azure-infra
                pwd  # This should now print /home/runner/work/pcsprashanth/azure-infra
            
            - name: current the working directory
              run: pwd
            
            - name: Terragrunt Init
              run: terragrunt init
              working-directory: home/runner/work/azure-infra/
              

            - name: Terragrunt Plan
              run: terragrunt plan
              

            - name: Terragrunt Apply
              run: terragrunt apply -auto-approve